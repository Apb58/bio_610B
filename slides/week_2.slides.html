<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Peter Ralph">
  <title>Adding levels of randomness</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="reveal.js/css/reveal.css">
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="reveal.js/css/theme/simple.css" id="theme">
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>
  <!--[if lt IE 9]>
  <script src="reveal.js/lib/js/html5shiv.js"></script>
  <![endif]-->
  <style type="text/css">
  
  .reveal { font-size: 30px; }
  
  .reveal h1 { font-size: 1.5em; } 
  
  .reveal h2 { font-size: 1.2em; } 
  
  .reveal .slides { text-align: left; }
  
  .reveal .slides figure { text-align: center; }
  
  .reveal figcaption { display: none; }
  
  </style>
  <div style="display: none">
  \[
  %%
  % Add your macros here; they'll be included in pdf and html output.
  %%
  
  \newcommand{\R}{\mathbb{R}}    % reals
  \newcommand{\E}{\mathbb{E}}    % expectation
  \renewcommand{\P}{\mathbb{P}}  % probability
  \DeclareMathOperator{\sd}{sd}
  \DeclareMathOperator{\var}{var}
  \DeclareMathOperator{\Normal}{Normal}
  \DeclareMathOperator{\Poisson}{Poisson}
  \DeclareMathOperator{\Beta}{Beta}
  \DeclareMathOperator{\Binom}{Binomial}
  \DeclareMathOperator{\Gam}{Gamma}
  \DeclareMathOperator{\Exp}{Exponential}
  
  
  \newcommand{\given}{\;\vert\;}
  \]
  </div>
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section id="title-slide">
  <h1 class="title">Adding levels of randomness</h1>
  <p class="author">Peter Ralph</p>
  <p class="date">15 January 2018 – Advanced Biological Statistics</p>
</section>

<section id="outline" class="slide level2">
<h2>Outline</h2>
<ol type="1">
<li><p>Credible intervals</p>
<ul>
<li>applied to the Beta-Binomial example</li>
</ul></li>
<li><p>Hierarchical coins</p></li>
<li><p>Introduction to MCMC</p></li>
<li><p>Stan</p></li>
</ol>
</section>
<section><section id="reporting-uncertainty" class="title-slide slide level1"><h1>Reporting uncertainty</h1></section><section id="how-do-we-communicate-results" class="slide level2">
<h2>How do we communicate results?</h2>
<p>If we want a <em>point estimate</em>:</p>
<ol type="1">
<li>posterior mean,</li>
<li>posterior median, or</li>
<li>maximum <em>a posteriori</em> estimate (“MAP”: highest posterior density).</li>
</ol>
<p>These all convey “where the posterior distribution is”, more or less.</p>
<div class="fragment">
<p>What about uncertainty?</p>
</div>
</section><section id="credible-region" class="slide level2">
<h2>Credible region</h2>
<p><strong>Definition:</strong> A 95% <em>credible region</em> is a portion of parameter space having a total of 95% of the <em>posterior probability</em>.</p>
<div class="fragment">
<p>(same with other numbers for “95%”)</p>
</div>
</section><section id="interpretation-1" class="slide level2">
<h2>Interpretation #1</h2>
<p>If we construct a 95% credible interval for <span class="math inline">\(\theta\)</span> for each of many datasets; <em>and</em> the coin in each dataset has <span class="math inline">\(\theta\)</span> drawn independently from the prior, <em>then</em> the true <span class="math inline">\(\theta\)</span> will fall in its credible interval for 95% of the datasets.</p>
</section><section id="interpretation-2" class="slide level2">
<h2>Interpretation #2</h2>
<p>If we construct a 95% credible interval for <span class="math inline">\(\theta\)</span> with a dataset, and the distribution of the coin’s true <span class="math inline">\(\theta\)</span> across many parallel universes is given by the prior, then the true <span class="math inline">\(\theta\)</span> will be in the credible interval in 95% of those universes.</p>
</section><section id="interpretation-3" class="slide level2">
<h2>Interpretation #3</h2>
<p>Given my prior beliefs (prior distribution), the posterior distribution is the most rational<span class="math inline">\({}^*\)</span> way to update my beliefs to account for the data.</p>
<div class="fragment">
<p><span class="math inline">\({}^*\)</span> if you do this many times you will be wrong least often</p>
</div>
<div class="fragment">
<p><span class="math inline">\({}^*\)</span> <strong>or</strong> you will be wrong in the fewest possible universes</p>
</div>
</section><section id="but-which-credible-interval" class="slide level2">
<h2>But which credible interval?</h2>
<p><strong>Definition:</strong> The “95% highest density interval” is the 95% credible interval with the highest posterior probability density at each point.</p>
<div class="fragment">
<p>((back to the simple example))</p>
</div>
</section></section>
<section><section id="hierarchical-coins" class="title-slide slide level1"><h1>Hierarchical coins</h1></section><section id="motivating-problem-more-coins" class="slide level2">
<h2>Motivating problem: more coins</h2>
<p>Suppose now we have data from <span class="math inline">\(n\)</span> different coins from the same source <em>(or, sequences, or …)</em></p>
<p>Suppose now we have data from <span class="math inline">\(n\)</span> different coins from the same source. We don’t assume they have the <em>same</em> <span class="math inline">\(\theta\)</span>, but don’t know what it’s distribution is, so try to <em>learn</em> it.</p>
<p><span class="math display">\[\begin{aligned}
    Z_i &amp;\sim \Binom(N_i, \theta_i) \\
    \theta_i &amp;\sim \Beta(\text{mode}=\omega, \text{conc}=\kappa) \\
    \omega &amp;\sim \Beta(A, B) \\
    \kappa &amp;\sim \Gam(S, R)
\end{aligned}\]</span></p>
<p><em>note:</em> The “mode” and “concentration” are related to the shape parameters by: <span class="math inline">\(\alpha = \omega (\kappa - 2) + 1\)</span> and <span class="math inline">\(\beta = (1 - \omega) (\kappa - 2) + 1\)</span>.</p>
</section><section id="binomial-versus-beta-binomial" class="slide level2">
<h2>Binomial versus Beta-Binomial</h2>
<p>What is different between:</p>
<ol type="1">
<li><p>Pick a value of <span class="math inline">\(\theta\)</span> at random from <span class="math inline">\(\Beta(3,1)\)</span>. Flip one thousand <span class="math inline">\(\theta\)</span>-coins, 500 times each.</p></li>
<li><p>Pick one thousand random <span class="math inline">\(\theta_i \sim \Beta(3,1)\)</span> values. Flip one thousand coins, one for each <span class="math inline">\(\theta_i\)</span>, 500 times each.</p></li>
</ol>
<p>In which case does knowing the outcome of one coin give you information about the likely behavior of other coins?</p>
</section><section class="slide level2">

<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">ncoins &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">nflips &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">theta1 &lt;-<span class="st"> </span><span class="kw">rbeta</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">binom_Z &lt;-<span class="st"> </span><span class="kw">rbinom</span>(ncoins, <span class="dt">size=</span>nflips, <span class="dt">prob=</span>theta1)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">theta2 &lt;-<span class="st"> </span><span class="kw">rbeta</span>(ncoins,<span class="dv">3</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">bb_Z &lt;-<span class="st"> </span><span class="kw">rbinom</span>(ncoins, <span class="dt">size=</span>nflips, <span class="dt">prob=</span>theta2)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">hist</span>(binom_Z, <span class="dt">breaks=</span><span class="dv">30</span>, <span class="dt">col=</span><span class="kw">adjustcolor</span>(<span class="st">&quot;blue&quot;</span>, <span class="fl">0.5</span>), <span class="dt">main=</span><span class="st">&#39;&#39;</span>, <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>,nflips), <span class="dt">freq=</span><span class="ot">FALSE</span>, <span class="dt">xlab=</span><span class="st">&#39;number of Heads&#39;</span>)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">hist</span>(bb_Z, <span class="dt">breaks=</span><span class="dv">30</span>, <span class="dt">col=</span><span class="kw">adjustcolor</span>(<span class="st">&quot;red&quot;</span>, <span class="fl">0.5</span>), <span class="dt">add=</span><span class="ot">TRUE</span>, <span class="dt">freq=</span><span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="figure/week_2/beta_or_binom-1.png" title="plot of chunk beta_or_binom" alt="plot of chunk beta_or_binom" style="display: block; margin: auto;" /></p>
</section><section id="a-problem" class="slide level2">
<h2>A problem</h2>
<p><span class="math display">\[\begin{aligned}
    Z_i &amp;\sim \Binom(N_i, \theta_i) \\
    \theta_i &amp;\sim \Beta(\text{mode}=\omega, \text{conc}=\kappa) \\
    \omega &amp;\sim \Beta(A, B) \\
    \kappa &amp;\sim \Gam(S, R)
\end{aligned}\]</span></p>
<p><strong>Goal:</strong> find the posterior distribution of <span class="math inline">\(\omega\)</span>, <span class="math inline">\(\kappa\)</span>, and <span class="math inline">\(\theta_1, \ldots, \theta_n\)</span>.</p>
<div class="fragment">
<p><strong>Problem:</strong> we don’t have a nice mathematical expression for this posterior distribution.</p>
</div>
</section></section>
<section><section id="markov-chain-monte-carlo" class="title-slide slide level1"><h1>Markov Chain Monte Carlo</h1></section><section id="when-you-cant-do-the-integrals-mcmc" class="slide level2">
<h2>When you can’t do the integrals: MCMC</h2>
<p><strong>Goal:</strong> Given:</p>
<ul>
<li>a model with parameters <span class="math inline">\(\theta\)</span>,</li>
<li>a prior distribution <span class="math inline">\(p(\theta)\)</span> on <span class="math inline">\(\theta\)</span>, and</li>
<li>data, <span class="math inline">\(D\)</span>,</li>
</ul>
<p>“find”/ask questions of the posterior distribution on <span class="math inline">\(\theta\)</span>,</p>
<p><span class="math display">\[\begin{aligned}
    p(\theta \given D) = \frac{ p(D \given \theta) p(\theta) }{ p(D) } .
\end{aligned}\]</span></p>
<div class="fragment">
<p><strong>Problem:</strong> usually we can’t write down an expression for this (because of the “<span class="math inline">\(p(D)\)</span>”).</p>
</div>
<div class="fragment">
<p><strong>Solution:</strong> we’ll make up a way to <em>draw random samples</em> from it.</p>
</div>
</section><section class="slide level2">

<p><strong>Toy example:</strong></p>
<p><em>(return to beta-binomial coin example)</em></p>
<p>Do we think that <span class="math inline">\(\theta &lt; 0.5\)</span>?</p>
<p><em>(before:)</em></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">pbeta</span>(<span class="fl">0.5</span>, post_a, post_b)</a></code></pre></div>
<p><em>(now:)</em></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">mean</span>(<span class="kw">rbeta</span>(<span class="fl">1e6</span>, post_a, post_b) <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.5</span>)</a></code></pre></div>
</section><section id="how-markov-chain-monte-carlo" class="slide level2">
<h2>How? Markov chain Monte Carlo!</h2>
<p>i.e., “random-walk-based stochastic integration”</p>
<p><strong>Example:</strong> Gibbs sampling for uniform distribution on a region. <em>(picture)</em></p>
</section><section id="overview-of-mcmc" class="slide level2">
<h2>Overview of MCMC</h2>
<p>Produces a random sequence of samples <span class="math inline">\(\theta_1, \theta_2, \ldots, \theta_N\)</span>.</p>
<ol start="0" type="1">
<li>Begin somewhere (at <span class="math inline">\(\theta_1\)</span>).</li>
</ol>
<p>At each step, starting at <span class="math inline">\(\theta_k\)</span>:</p>
<ol type="1">
<li><p><strong>Propose</strong> a new location (nearby?): <span class="math inline">\(\theta_k&#39;\)</span></p></li>
<li><p>Decide whether to <strong>accept</strong> it.</p>
<ul>
<li>if so: set <span class="math inline">\(\theta_{k+1} \leftarrow \theta_k&#39;\)</span></li>
<li>if not: set <span class="math inline">\(\theta_{k+1} \leftarrow \theta_k\)</span></li>
</ul></li>
<li><p>Set <span class="math inline">\(k \leftarrow k+1\)</span>; if <span class="math inline">\(k=N\)</span> then stop.</p></li>
</ol>
<div class="fragment">
<p>The magic comes from doing <em>proposals</em> and <em>acceptance</em> so that the <span class="math inline">\(\theta\)</span>’s are samples from the distribution we want.</p>
</div>
</section><section id="key-concepts" class="slide level2">
<h2>Key concepts</h2>
<ul>
<li><p>Rules are chosen so that <span class="math inline">\(p(\theta \given D)\)</span> is the <em>stationary</em> distribution (long-run average!) of the random walk (the “Markov chain”).</p></li>
<li><p>The chain must <em>mix</em> fast enough so the distribution of visited states <em>converges</em> to <span class="math inline">\(p(\theta \given D)\)</span>.</p></li>
<li><p>Because of <em>autocorrelation</em>, <span class="math inline">\((\theta_1, \theta_2, \ldots, \theta_N)\)</span> are not <span class="math inline">\(N\)</span> independent samples: they are roughly equivalent to <span class="math inline">\(N_\text{eff} &lt; N\)</span> independent samples.</p></li>
<li><p>For better <em>mixing</em>, acceptance probabilities should not be too high or too low.</p></li>
<li><p>Starting <em>several chains</em> far apart can help diagnose failure to mix: Gelman’s <span class="math inline">\(r\)</span> (“shrink”) quantifies how different they are.</p></li>
</ul>
</section><section id="on-your-feet" class="slide level2">
<h2>On your feet</h2>
<p>Three people, with randomness provided by others:</p>
<ol type="1">
<li><p>Pick a random <span class="math inline">\(\{N,S,E,W\}\)</span>.</p></li>
<li><p>Take a step in that direction,</p>
<ul>
<li><em>unless</em> you’d run into a wall or a table.</li>
</ul></li>
</ol>
<div class="fragment">
<p><strong>Question:</strong> What distribution will this sample from?</p>
</div>
<div class="fragment">
<p>Do this for 10 iterations. Have the <em>chains mixed</em>?</p>
</div>
</section><section class="slide level2">

<p><strong>Now:</strong></p>
<ol type="1">
<li><p>Pick a random <span class="math inline">\(\{N,S,E,W\}\)</span>.</p></li>
<li><p>Take a <span class="math inline">\(1+\Poisson(5)\)</span> number of steps in that direction,</p>
<ul>
<li><em>unless</em> you’d run into a wall or a table.</li>
</ul></li>
</ol>
<div class="fragment">
<p>Does it mix faster?</p>
</div>
<div class="fragment">
<p>Would <span class="math inline">\(1 + \Poisson(50)\)</span> steps be better?</p>
</div>
</section><section id="how-it-works" class="slide level2">
<h2>How it works</h2>
<p>Imagine the walkers are on a hill, and:</p>
<ol type="1">
<li><p>Pick a random <span class="math inline">\(\{N,S,E,W\}\)</span>.</p></li>
<li><p>If</p>
<ul>
<li>the step is <em>uphill</em>, then take it.</li>
<li>the step is <em>downhill</em>, then flip a <span class="math inline">\(p\)</span>-coin; if you get Heads, stay were you are.</li>
</ul></li>
</ol>
<p>What would <em>this</em> do?</p>
<div class="fragment">
<p>Thanks to <em>Metropolis-Hastings</em>, if “elevation” is <span class="math inline">\(p(\theta \given D)\)</span>, then setting <span class="math inline">\(p = p(\theta&#39; \given D) / p(\theta \given D)\)</span> makes the stationary distribution <span class="math inline">\(p(\theta \given D)\)</span>.</p>
</div>
</section></section>
<section><section id="mc-stan" class="title-slide slide level1"><h1>MC Stan</h1></section><section id="quick-and-easy-mcmc-stan" class="slide level2">
<h2>“Quick and easy” MCMC: Stan</h2>
<figure>
<img data-src="stan.jpeg" alt="Stanislaw Ulam" style="height:10em" /><figcaption>Stanislaw Ulam</figcaption>
</figure>
</section><section id="the-skeletal-stan-program" class="slide level2">
<h2>The skeletal Stan program</h2>
<pre><code>data {
    // stuff you input
}
transformed data {
    // stuff that&#39;s calculated from the data (just once, at the start)
}
parameters {
    // stuff you want to learn the posterior distribution of
}
transformed parameters {
    // stuff that&#39;s calculated from the parameters (at every step)
}
model {
    // the action!
}
generated quantities {
    // stuff you want computed also along the way
}</code></pre>
</section></section>
<section><section id="beta-binomial-with-stan" class="title-slide slide level1"><h1>Beta-Binomial with Stan</h1></section><section id="first-in-words" class="slide level2">
<h2>First, in words:</h2>
<p>We’ve flipped a coin 10 times and got 6 Heads. We think the coin is close to fair, so put a <span class="math inline">\(\Beta(20,20)\)</span> prior on it’s probability of heads, and want the posterior distribution.</p>
<p><span class="math display">\[\begin{aligned}
    Z &amp;\sim \Binom(10, \theta) \\
    \theta &amp;\sim \Beta(20, 20) 
\end{aligned}\]</span> Sample from <span class="math display">\[\theta \given Z = 6\]</span></p>
</section><section class="slide level2">

<div class="columns">
<div class="column" style="width:50%;">
<p><span class="math display">\[\begin{aligned}
    Z &amp;\sim \Binom(10, \theta) \\
    \theta &amp;\sim \Beta(20, 20) 
\end{aligned}\]</span></p>
<p>Sample from <span class="math display">\[\theta \given Z = 6\]</span></p>
</div><div class="column" style="width:50%;">
<pre><code>data {
    // stuff you input
}
parameters {
    // stuff you want to learn 
    // the posterior distribution of
}
model {
    // the action!
}</code></pre>
</div>
</div>
</section><section class="slide level2">

<div class="columns">
<div class="column" style="width:50%;">
<p><span class="math display">\[\begin{aligned}
    Z &amp;\sim \Binom(10, \theta) \\
    \theta &amp;\sim \Beta(20, 20) 
\end{aligned}\]</span></p>
<p>Sample from <span class="math display">\[\theta \given Z = 6\]</span></p>
</div><div class="column" style="width:50%;">
<pre><code>data {
    int N;   // number of flips
    int Z;   // number of heads
}
parameters {
    // stuff you want to learn 
    // the posterior distribution of
}
model {
    // the action!
}</code></pre>
</div>
</div>
</section><section class="slide level2">

<div class="columns">
<div class="column" style="width:50%;">
<p><span class="math display">\[\begin{aligned}
    Z &amp;\sim \Binom(10, \theta) \\
    \theta &amp;\sim \Beta(20, 20) 
\end{aligned}\]</span></p>
<p>Sample from <span class="math display">\[\theta \given Z = 6\]</span></p>
</div><div class="column" style="width:50%;">
<pre><code>data {
    int N;   // number of flips
    int Z;   // number of heads
}
parameters {
    // probability of heads
    real&lt;lower=0,upper=1&gt; theta;  
}
model {
    // the action!
}</code></pre>
</div>
</div>
</section><section class="slide level2">

<div class="columns">
<div class="column" style="width:50%;">
<p><span class="math display">\[\begin{aligned}
    Z &amp;\sim \Binom(10, \theta) \\
    \theta &amp;\sim \Beta(20, 20) 
\end{aligned}\]</span></p>
<p>Sample from <span class="math display">\[\theta \given Z = 6\]</span></p>
</div><div class="column" style="width:50%;">
<pre><code>data {
    int N;   // number of flips
    int Z;   // number of heads
}
parameters {
    // probability of heads
    real&lt;lower=0,upper=1&gt; theta;
}
model {
    Z ~ binomial(N, theta);
    theta ~ beta(20, 20);
}</code></pre>
</div>
</div>
</section><section id="running-the-mcmc-rstan" class="slide level2">
<h2>Running the MCMC: rstan</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">library</span>(rstan)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">fit &lt;-<span class="st"> </span><span class="kw">stan</span>(<span class="dt">model_code=</span>stan_block,  <span class="co"># stan block from above</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">            <span class="dt">data=</span><span class="kw">list</span>(<span class="dt">N=</span><span class="dv">10</span>, <span class="dt">Z=</span><span class="dv">6</span>),</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">            <span class="dt">chains=</span><span class="dv">3</span>, <span class="dt">iter=</span><span class="dv">10000</span>)</a></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL &#39;5f3115ac9593cded393e67d2d0e3ce84&#39; NOW (CHAIN 1).
## 
## Gradient evaluation took 6e-06 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.06 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:    1 / 10000 [  0%]  (Warmup)
## Iteration: 1000 / 10000 [ 10%]  (Warmup)
## Iteration: 2000 / 10000 [ 20%]  (Warmup)
## Iteration: 3000 / 10000 [ 30%]  (Warmup)
## Iteration: 4000 / 10000 [ 40%]  (Warmup)
## Iteration: 5000 / 10000 [ 50%]  (Warmup)
## Iteration: 5001 / 10000 [ 50%]  (Sampling)
## Iteration: 6000 / 10000 [ 60%]  (Sampling)
## Iteration: 7000 / 10000 [ 70%]  (Sampling)
## Iteration: 8000 / 10000 [ 80%]  (Sampling)
## Iteration: 9000 / 10000 [ 90%]  (Sampling)
## Iteration: 10000 / 10000 [100%]  (Sampling)
## 
##  Elapsed Time: 0.032793 seconds (Warm-up)
##                0.029107 seconds (Sampling)
##                0.0619 seconds (Total)
## 
## 
## SAMPLING FOR MODEL &#39;5f3115ac9593cded393e67d2d0e3ce84&#39; NOW (CHAIN 2).
## 
## Gradient evaluation took 3e-06 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.03 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:    1 / 10000 [  0%]  (Warmup)
## Iteration: 1000 / 10000 [ 10%]  (Warmup)
## Iteration: 2000 / 10000 [ 20%]  (Warmup)
## Iteration: 3000 / 10000 [ 30%]  (Warmup)
## Iteration: 4000 / 10000 [ 40%]  (Warmup)
## Iteration: 5000 / 10000 [ 50%]  (Warmup)
## Iteration: 5001 / 10000 [ 50%]  (Sampling)
## Iteration: 6000 / 10000 [ 60%]  (Sampling)
## Iteration: 7000 / 10000 [ 70%]  (Sampling)
## Iteration: 8000 / 10000 [ 80%]  (Sampling)
## Iteration: 9000 / 10000 [ 90%]  (Sampling)
## Iteration: 10000 / 10000 [100%]  (Sampling)
## 
##  Elapsed Time: 0.030678 seconds (Warm-up)
##                0.040473 seconds (Sampling)
##                0.071151 seconds (Total)
## 
## 
## SAMPLING FOR MODEL &#39;5f3115ac9593cded393e67d2d0e3ce84&#39; NOW (CHAIN 3).
## 
## Gradient evaluation took 6e-06 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.06 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:    1 / 10000 [  0%]  (Warmup)
## Iteration: 1000 / 10000 [ 10%]  (Warmup)
## Iteration: 2000 / 10000 [ 20%]  (Warmup)
## Iteration: 3000 / 10000 [ 30%]  (Warmup)
## Iteration: 4000 / 10000 [ 40%]  (Warmup)
## Iteration: 5000 / 10000 [ 50%]  (Warmup)
## Iteration: 5001 / 10000 [ 50%]  (Sampling)
## Iteration: 6000 / 10000 [ 60%]  (Sampling)
## Iteration: 7000 / 10000 [ 70%]  (Sampling)
## Iteration: 8000 / 10000 [ 80%]  (Sampling)
## Iteration: 9000 / 10000 [ 90%]  (Sampling)
## Iteration: 10000 / 10000 [100%]  (Sampling)
## 
##  Elapsed Time: 0.034736 seconds (Warm-up)
##                0.033437 seconds (Sampling)
##                0.068173 seconds (Total)</code></pre>
</section><section class="slide level2">

<p><code>lp__</code> is the log posterior density. Note <code>n_eff</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">print</span>(fit)</a></code></pre></div>
<pre><code>## Inference for Stan model: 5f3115ac9593cded393e67d2d0e3ce84.
## 3 chains, each with iter=10000; warmup=5000; thin=1; 
## post-warmup draws per chain=5000, total post-warmup draws=15000.
## 
##         mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## theta   0.52    0.00 0.07   0.39   0.47   0.52   0.57   0.65  5162    1
## lp__  -35.11    0.01 0.69 -37.05 -35.28 -34.85 -34.67 -34.62  7664    1
## 
## Samples were drawn using NUTS(diag_e) at Tue Jan 16 09:32:16 2018.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
</section><section class="slide level2">

<p>Fuzzy caterpillars are good.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">stan_trace</span>(fit)</a></code></pre></div>
<p><img src="figure/week_2/trace_rstan-1.png" title="plot of chunk trace_rstan" alt="plot of chunk trace_rstan" style="display: block; margin: auto;" /></p>
</section><section class="slide level2">

<p>Stan uses ggplot2.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">stan_hist</span>(fit) <span class="op">+</span><span class="st"> </span><span class="kw">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>)</a></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="figure/week_2/plot_rstan-1.png" title="plot of chunk plot_rstan" alt="plot of chunk plot_rstan" style="display: block; margin: auto;" /></p>
</section><section class="slide level2">

<p>What’s the posterior probability that <span class="math inline">\(\theta &lt; 0.5\)</span>?</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">samples &lt;-<span class="st"> </span><span class="kw">extract</span>(fit)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw">mean</span>(samples<span class="op">$</span>theta <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.5</span>)</a></code></pre></div>
<pre><code>## [1] 0.3792</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># compare to analytic solution</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw">pbeta</span>(<span class="fl">0.5</span>, <span class="dt">shape1=</span><span class="dv">10</span><span class="op">+</span><span class="dv">6</span>, <span class="dt">shape2=</span><span class="dv">10</span><span class="op">+</span><span class="dv">4</span>)</a></code></pre></div>
<pre><code>## [1] 0.3555356</code></pre>
</section><section id="your-turn" class="slide level2">
<h2>Your turn!</h2>
<p>We’ve flipped a coin 100 times and got 23 Heads. We don’t want the prior to affect our results, so put a <span class="math inline">\(\Beta(1,1)\)</span> prior on it’s probability of heads, and want the posterior distribution.</p>
<p><strong>Question:</strong> What’s the posterior probability that <span class="math inline">\(\theta &lt; 0.15\)</span>?</p>
</section></section>
<section><section id="stochastic-minute" class="title-slide slide level1"><h1>Stochastic minute</h1></section><section id="exponential-and-gamma" class="slide level2">
<h2>Exponential, and Gamma</h2>
<p>If <span class="math inline">\(T \sim \Exp(\text{rate}=\lambda)\)</span>, then</p>
<p><span class="math display">\[\begin{aligned}
   \P\{ T \in dt \} = \lambda e^{-\lambda t} dt .
\end{aligned}\]</span></p>
<ol type="1">
<li><p><span class="math inline">\(T\)</span> can be any nonnegative real number.</p></li>
<li><p><span class="math inline">\(T\)</span> is <em>memoryless</em>: <span class="math display">\[\begin{aligned}
     \P\{ T &gt; x + y \given T &gt; x \} = \P\{ T &gt; y \} .
\end{aligned}\]</span></p></li>
<li><p>A machine produces <span class="math inline">\(n\)</span> widgets per second; each widget has probability <span class="math inline">\(\lambda/n\)</span> of being broken. The time until the first broken widget appears (in seconds) is approximately <span class="math inline">\(\sim \Exp(\lambda)\)</span>.</p></li>
</ol>
</section><section class="slide level2">

<p>If <span class="math inline">\(S \sim \Gam(\text{shape}=\alpha, \text{rate}=\lambda)\)</span>, then</p>
<p><span class="math display">\[\begin{aligned}
   \P\{ S \in dt \} = \frac{\alpha^\lambda}{\Gam(\alpha)} t^{\alpha - 1} e^{-\lambda t} dt .
\end{aligned}\]</span></p>
<ol type="1">
<li><p>If <span class="math inline">\(T_1, \ldots, T_k\)</span> are independent <span class="math inline">\(\Exp(\lambda)\)</span>, then <span class="math inline">\(S = T_1 + \cdots + T_k\)</span> is <span class="math inline">\(\Gam(k, \lambda)\)</span>.</p></li>
<li><p>A machine produces <span class="math inline">\(n\)</span> widgets per second; each widget has probability <span class="math inline">\(\lambda/n\)</span> of being broken. The time until the <span class="math inline">\(k^\text{th}\)</span> broken widget appears (in seconds) is approximately <span class="math inline">\(\sim \Gam(k, \lambda)\)</span>.</p></li>
</ol>
</section></section>
<section><section id="hierarchical-coins-with-stan" class="title-slide slide level1"><h1>“Hierarchical Coins” with Stan</h1></section><section id="baseball" class="slide level2">
<h2>Baseball</h2>
<p>We have <a href="../demos/BattingAverage.csv">a dataset</a> of batting averages of baseball players, having</p>
<ol type="1">
<li>name</li>
<li>position</li>
<li>number of “at bats”</li>
<li>number of hits</li>
</ol>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">batting &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;../demos/BattingAverage.csv&quot;</span>, <span class="dt">header=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="kw">head</span>(batting)</a></code></pre></div>
<pre><code>##          Player     PriPos Hits AtBats PlayerNumber PriPosNumber
## 1 Fernando Abad    Pitcher    1      7            1            1
## 2   Bobby Abreu Left Field   53    219            2            7
## 3    Tony Abreu   2nd Base   18     70            3            4
## 4 Dustin Ackley   2nd Base  137    607            4            4
## 5    Matt Adams   1st Base   21     86            5            3
## 6 Nathan Adcock    Pitcher    0      1            6            1</code></pre>
</section><section class="slide level2">

<p>The <em>overall</em> batting average of the 948 players is 0.2546597.</p>
<p>Here is the average by position.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">batting <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(PriPos) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">num=</span><span class="kw">n</span>(), <span class="dt">BatAvg=</span><span class="kw">sum</span>(Hits)<span class="op">/</span><span class="kw">sum</span>(AtBats)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="st">    </span><span class="kw">select</span>(PriPos, num, BatAvg)</a></code></pre></div>
<pre><code>## # A tibble: 9 x 3
##   PriPos         num BatAvg
##   &lt;fctr&gt;       &lt;int&gt;  &lt;dbl&gt;
## 1 1st Base        81  0.259
## 2 2nd Base        72  0.256
## 3 3rd Base        75  0.265
## 4 Catcher        103  0.247
## 5 Center Field    67  0.264
## 6 Left Field     103  0.259
## 7 Pitcher        324  0.129
## 8 Right Field     60  0.264
## 9 Shortstop       63  0.255</code></pre>
</section><section id="questions" class="slide level2">
<h2>Questions?</h2>
<ol type="1">
<li><p>What’s the overall batting average?</p></li>
<li><p>Do some positions tend to be better batters?</p></li>
<li><p>How much variation is there?</p></li>
</ol>
</section><section id="everyone-is-the-same" class="slide level2">
<h2>Everyone is the same</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">first_model &lt;-<span class="st"> &quot;</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="st">data {</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="st">    int N;</span></a>
<a class="sourceLine" id="cb24-4" data-line-number="4"><span class="st">    int hits[N];</span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="st">    int at_bats[N];</span></a>
<a class="sourceLine" id="cb24-6" data-line-number="6"><span class="st">}</span></a>
<a class="sourceLine" id="cb24-7" data-line-number="7"><span class="st">parameters {</span></a>
<a class="sourceLine" id="cb24-8" data-line-number="8"><span class="st">    real&lt;lower=0, upper=1&gt; theta;</span></a>
<a class="sourceLine" id="cb24-9" data-line-number="9"><span class="st">}</span></a>
<a class="sourceLine" id="cb24-10" data-line-number="10"><span class="st">model {</span></a>
<a class="sourceLine" id="cb24-11" data-line-number="11"><span class="st">    hits ~ binomial(at_bats, theta);</span></a>
<a class="sourceLine" id="cb24-12" data-line-number="12"><span class="st">    theta ~ beta(1, 1);</span></a>
<a class="sourceLine" id="cb24-13" data-line-number="13"><span class="st">} &quot;</span></a>
<a class="sourceLine" id="cb24-14" data-line-number="14">first_fit &lt;-<span class="st"> </span><span class="kw">stan</span>(<span class="dt">model_code=</span>first_model, <span class="dt">chains=</span><span class="dv">3</span>, <span class="dt">iter=</span><span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb24-15" data-line-number="15">                  <span class="dt">data=</span><span class="kw">list</span>(<span class="dt">N=</span><span class="kw">nrow</span>(batting),</a>
<a class="sourceLine" id="cb24-16" data-line-number="16">                            <span class="dt">hits=</span>batting<span class="op">$</span>Hits,</a>
<a class="sourceLine" id="cb24-17" data-line-number="17">                            <span class="dt">at_bats=</span>batting<span class="op">$</span>AtBats))</a></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL &#39;19bcc9c3db3197c73e8a92569f4a671f&#39; NOW (CHAIN 1).
## 
## Gradient evaluation took 3.2e-05 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.32 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:   1 / 1000 [  0%]  (Warmup)
## Iteration: 100 / 1000 [ 10%]  (Warmup)
## Iteration: 200 / 1000 [ 20%]  (Warmup)
## Iteration: 300 / 1000 [ 30%]  (Warmup)
## Iteration: 400 / 1000 [ 40%]  (Warmup)
## Iteration: 500 / 1000 [ 50%]  (Warmup)
## Iteration: 501 / 1000 [ 50%]  (Sampling)
## Iteration: 600 / 1000 [ 60%]  (Sampling)
## Iteration: 700 / 1000 [ 70%]  (Sampling)
## Iteration: 800 / 1000 [ 80%]  (Sampling)
## Iteration: 900 / 1000 [ 90%]  (Sampling)
## Iteration: 1000 / 1000 [100%]  (Sampling)
## 
##  Elapsed Time: 0.050758 seconds (Warm-up)
##                0.037675 seconds (Sampling)
##                0.088433 seconds (Total)
## 
## 
## SAMPLING FOR MODEL &#39;19bcc9c3db3197c73e8a92569f4a671f&#39; NOW (CHAIN 2).
## 
## Gradient evaluation took 2.4e-05 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.24 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:   1 / 1000 [  0%]  (Warmup)
## Iteration: 100 / 1000 [ 10%]  (Warmup)
## Iteration: 200 / 1000 [ 20%]  (Warmup)
## Iteration: 300 / 1000 [ 30%]  (Warmup)
## Iteration: 400 / 1000 [ 40%]  (Warmup)
## Iteration: 500 / 1000 [ 50%]  (Warmup)
## Iteration: 501 / 1000 [ 50%]  (Sampling)
## Iteration: 600 / 1000 [ 60%]  (Sampling)
## Iteration: 700 / 1000 [ 70%]  (Sampling)
## Iteration: 800 / 1000 [ 80%]  (Sampling)
## Iteration: 900 / 1000 [ 90%]  (Sampling)
## Iteration: 1000 / 1000 [100%]  (Sampling)
## 
##  Elapsed Time: 0.044149 seconds (Warm-up)
##                0.037231 seconds (Sampling)
##                0.08138 seconds (Total)
## 
## 
## SAMPLING FOR MODEL &#39;19bcc9c3db3197c73e8a92569f4a671f&#39; NOW (CHAIN 3).
## 
## Gradient evaluation took 2.5e-05 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.25 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:   1 / 1000 [  0%]  (Warmup)
## Iteration: 100 / 1000 [ 10%]  (Warmup)
## Iteration: 200 / 1000 [ 20%]  (Warmup)
## Iteration: 300 / 1000 [ 30%]  (Warmup)
## Iteration: 400 / 1000 [ 40%]  (Warmup)
## Iteration: 500 / 1000 [ 50%]  (Warmup)
## Iteration: 501 / 1000 [ 50%]  (Sampling)
## Iteration: 600 / 1000 [ 60%]  (Sampling)
## Iteration: 700 / 1000 [ 70%]  (Sampling)
## Iteration: 800 / 1000 [ 80%]  (Sampling)
## Iteration: 900 / 1000 [ 90%]  (Sampling)
## Iteration: 1000 / 1000 [100%]  (Sampling)
## 
##  Elapsed Time: 0.04167 seconds (Warm-up)
##                0.03643 seconds (Sampling)
##                0.0781 seconds (Total)</code></pre>
</section><section class="slide level2">

<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">stan_hist</span>(first_fit)</a></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="figure/week_2/start_res-1.png" title="plot of chunk start_res" alt="plot of chunk start_res" style="display: block; margin: auto;" /></p>
</section><section id="every-pitcher-is-the-same" class="slide level2">
<h2>Every pitcher is the same</h2>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">pos_model &lt;-<span class="st"> &quot;</span></a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="st">data {</span></a>
<a class="sourceLine" id="cb28-3" data-line-number="3"><span class="st">    int N;</span></a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="st">    int hits[N];</span></a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="st">    int at_bats[N];</span></a>
<a class="sourceLine" id="cb28-6" data-line-number="6"><span class="st">    int npos; // number of positions</span></a>
<a class="sourceLine" id="cb28-7" data-line-number="7"><span class="st">    int position[N];</span></a>
<a class="sourceLine" id="cb28-8" data-line-number="8"><span class="st">}</span></a>
<a class="sourceLine" id="cb28-9" data-line-number="9"><span class="st">parameters {</span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10"><span class="st">    real&lt;lower=0, upper=1&gt; theta[npos];</span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11"><span class="st">}</span></a>
<a class="sourceLine" id="cb28-12" data-line-number="12"><span class="st">model {</span></a>
<a class="sourceLine" id="cb28-13" data-line-number="13"><span class="st">    real theta_vec[N];</span></a>
<a class="sourceLine" id="cb28-14" data-line-number="14"><span class="st">    for (k in 1:N) {</span></a>
<a class="sourceLine" id="cb28-15" data-line-number="15"><span class="st">        theta_vec[k] = theta[position[k]];</span></a>
<a class="sourceLine" id="cb28-16" data-line-number="16"><span class="st">    }</span></a>
<a class="sourceLine" id="cb28-17" data-line-number="17"><span class="st">    hits ~ binomial(at_bats, theta_vec);</span></a>
<a class="sourceLine" id="cb28-18" data-line-number="18"><span class="st">    theta ~ beta(1, 1);</span></a>
<a class="sourceLine" id="cb28-19" data-line-number="19"><span class="st">} &quot;</span></a>
<a class="sourceLine" id="cb28-20" data-line-number="20">pos_fit &lt;-<span class="st"> </span><span class="kw">stan</span>(<span class="dt">model_code=</span>pos_model, <span class="dt">chains=</span><span class="dv">3</span>, <span class="dt">iter=</span><span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb28-21" data-line-number="21">                  <span class="dt">data=</span><span class="kw">list</span>(<span class="dt">N=</span><span class="kw">nrow</span>(batting),</a>
<a class="sourceLine" id="cb28-22" data-line-number="22">                            <span class="dt">hits=</span>batting<span class="op">$</span>Hits,</a>
<a class="sourceLine" id="cb28-23" data-line-number="23">                            <span class="dt">at_bats=</span>batting<span class="op">$</span>AtBats,</a>
<a class="sourceLine" id="cb28-24" data-line-number="24">                            <span class="dt">npos=</span><span class="kw">nlevels</span>(batting<span class="op">$</span>PriPos),</a>
<a class="sourceLine" id="cb28-25" data-line-number="25">                            <span class="dt">position=</span><span class="kw">as.numeric</span>(batting<span class="op">$</span>PriPos)))</a></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL &#39;44fb1922c86bd3c60c0d669cfb345a15&#39; NOW (CHAIN 1).
## 
## Gradient evaluation took 0.000109 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 1.09 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:   1 / 1000 [  0%]  (Warmup)
## Iteration: 100 / 1000 [ 10%]  (Warmup)
## Iteration: 200 / 1000 [ 20%]  (Warmup)
## Iteration: 300 / 1000 [ 30%]  (Warmup)
## Iteration: 400 / 1000 [ 40%]  (Warmup)
## Iteration: 500 / 1000 [ 50%]  (Warmup)
## Iteration: 501 / 1000 [ 50%]  (Sampling)
## Iteration: 600 / 1000 [ 60%]  (Sampling)
## Iteration: 700 / 1000 [ 70%]  (Sampling)
## Iteration: 800 / 1000 [ 80%]  (Sampling)
## Iteration: 900 / 1000 [ 90%]  (Sampling)
## Iteration: 1000 / 1000 [100%]  (Sampling)
## 
##  Elapsed Time: 0.22879 seconds (Warm-up)
##                0.215087 seconds (Sampling)
##                0.443877 seconds (Total)
## 
## 
## SAMPLING FOR MODEL &#39;44fb1922c86bd3c60c0d669cfb345a15&#39; NOW (CHAIN 2).
## 
## Gradient evaluation took 5.8e-05 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.58 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:   1 / 1000 [  0%]  (Warmup)
## Iteration: 100 / 1000 [ 10%]  (Warmup)
## Iteration: 200 / 1000 [ 20%]  (Warmup)
## Iteration: 300 / 1000 [ 30%]  (Warmup)
## Iteration: 400 / 1000 [ 40%]  (Warmup)
## Iteration: 500 / 1000 [ 50%]  (Warmup)
## Iteration: 501 / 1000 [ 50%]  (Sampling)
## Iteration: 600 / 1000 [ 60%]  (Sampling)
## Iteration: 700 / 1000 [ 70%]  (Sampling)
## Iteration: 800 / 1000 [ 80%]  (Sampling)
## Iteration: 900 / 1000 [ 90%]  (Sampling)
## Iteration: 1000 / 1000 [100%]  (Sampling)
## 
##  Elapsed Time: 0.215489 seconds (Warm-up)
##                0.391513 seconds (Sampling)
##                0.607002 seconds (Total)
## 
## 
## SAMPLING FOR MODEL &#39;44fb1922c86bd3c60c0d669cfb345a15&#39; NOW (CHAIN 3).
## 
## Gradient evaluation took 6.2e-05 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 0.62 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:   1 / 1000 [  0%]  (Warmup)
## Iteration: 100 / 1000 [ 10%]  (Warmup)
## Iteration: 200 / 1000 [ 20%]  (Warmup)
## Iteration: 300 / 1000 [ 30%]  (Warmup)
## Iteration: 400 / 1000 [ 40%]  (Warmup)
## Iteration: 500 / 1000 [ 50%]  (Warmup)
## Iteration: 501 / 1000 [ 50%]  (Sampling)
## Iteration: 600 / 1000 [ 60%]  (Sampling)
## Iteration: 700 / 1000 [ 70%]  (Sampling)
## Iteration: 800 / 1000 [ 80%]  (Sampling)
## Iteration: 900 / 1000 [ 90%]  (Sampling)
## Iteration: 1000 / 1000 [100%]  (Sampling)
## 
##  Elapsed Time: 0.223705 seconds (Warm-up)
##                0.1788 seconds (Sampling)
##                0.402505 seconds (Total)</code></pre>
</section><section class="slide level2">

<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">theta_samples &lt;-<span class="st"> </span><span class="kw">extract</span>(pos_fit)<span class="op">$</span>theta</a>
<a class="sourceLine" id="cb30-2" data-line-number="2"><span class="kw">layout</span>(<span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>, <span class="dt">nrow=</span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb30-3" data-line-number="3"><span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">ncol</span>(theta_samples)) {</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">    <span class="kw">hist</span>(theta_samples[,k], <span class="dt">main=</span><span class="kw">levels</span>(batting<span class="op">$</span>PriPos)[k], <span class="dt">xlim=</span><span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.3</span>),</a>
<a class="sourceLine" id="cb30-5" data-line-number="5">         <span class="dt">col=</span><span class="kw">adjustcolor</span>(<span class="st">&#39;red&#39;</span>,<span class="fl">0.6</span>), <span class="dt">xlab=</span><span class="st">&#39;batting avg&#39;</span>, <span class="dt">freq=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb30-6" data-line-number="6">}</a></code></pre></div>
<p><img src="figure/week_2/pos_res-1.png" title="plot of chunk pos_res" alt="plot of chunk pos_res" style="display: block; margin: auto;" /></p>
</section><section id="your-turn-1" class="slide level2">
<h2>Your turn :</h2>
<p>Every individual different:</p>
<div class="columns">
<div class="column" style="width:50%;">
<p><span class="math display">\[\begin{aligned}
    Z_i &amp;\sim \Binom(N_i, \theta_i) \\
    \theta_i &amp;\sim \Beta(\omega_{p_i}, \kappa_{p_i}) \\
    \omega_p &amp;\sim \Beta(1, 1) \\
    \kappa_p &amp;\sim \Gam(0.1, 0.1) .
\end{aligned}\]</span></p>
</div><div class="column" style="width:50%;">
<p>Variable types in Stan:</p>
<pre><code>int x;       // an integer
int y[10];   // ten integers
real z;      // a number
real z[2,5]; // a 2x5 array of numbers

vector u[10];      // length 10 vector
matrix v[10,10];   // 10x10 matrix
vector[10] w[10];  // ten length 10 vectors</code></pre>
<ul>
<li>don’t forget the <code>;</code></li>
<li>make sure R types match</li>
<li>read the error messages</li>
</ul>
</div>
</div>
</section><section class="slide level2">

<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">pos_model &lt;-<span class="st"> &quot;</span></a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="st">data {</span></a>
<a class="sourceLine" id="cb32-3" data-line-number="3"><span class="st">    int N;   // number of players</span></a>
<a class="sourceLine" id="cb32-4" data-line-number="4"><span class="st">    int hits[N];</span></a>
<a class="sourceLine" id="cb32-5" data-line-number="5"><span class="st">    int at_bats[N];</span></a>
<a class="sourceLine" id="cb32-6" data-line-number="6"><span class="st">    int npos; // number of positions</span></a>
<a class="sourceLine" id="cb32-7" data-line-number="7"><span class="st">    int position[N];</span></a>
<a class="sourceLine" id="cb32-8" data-line-number="8"><span class="st">}</span></a>
<a class="sourceLine" id="cb32-9" data-line-number="9"><span class="st">parameters {</span></a>
<a class="sourceLine" id="cb32-10" data-line-number="10"><span class="st">    real&lt;lower=0, upper=1&gt; theta[N];</span></a>
<a class="sourceLine" id="cb32-11" data-line-number="11"><span class="st">    real&lt;lower=0, upper=1&gt; omega[npos];</span></a>
<a class="sourceLine" id="cb32-12" data-line-number="12"><span class="st">    real&lt;lower=0&gt; kappa[npos];</span></a>
<a class="sourceLine" id="cb32-13" data-line-number="13"><span class="st">}</span></a>
<a class="sourceLine" id="cb32-14" data-line-number="14"><span class="st">model {</span></a>
<a class="sourceLine" id="cb32-15" data-line-number="15"><span class="st">    real alpha[N];</span></a>
<a class="sourceLine" id="cb32-16" data-line-number="16"><span class="st">    real beta[N];</span></a>
<a class="sourceLine" id="cb32-17" data-line-number="17"><span class="st">    for (i in 1:N) {</span></a>
<a class="sourceLine" id="cb32-18" data-line-number="18"><span class="st">        alpha[i] = omega[position[i]] * kappa[position[i]];</span></a>
<a class="sourceLine" id="cb32-19" data-line-number="19"><span class="st">        beta[i] = (1 - omega[position[i]]) * kappa[position[i]];</span></a>
<a class="sourceLine" id="cb32-20" data-line-number="20"><span class="st">    }</span></a>
<a class="sourceLine" id="cb32-21" data-line-number="21"><span class="st">    hits ~ binomial(at_bats, theta);</span></a>
<a class="sourceLine" id="cb32-22" data-line-number="22"><span class="st">    for (i in 1:N) {</span></a>
<a class="sourceLine" id="cb32-23" data-line-number="23"><span class="st">        theta[i] ~ beta(alpha[i], beta[i]);</span></a>
<a class="sourceLine" id="cb32-24" data-line-number="24"><span class="st">    }</span></a>
<a class="sourceLine" id="cb32-25" data-line-number="25"><span class="st">    omega ~ beta(1,1);</span></a>
<a class="sourceLine" id="cb32-26" data-line-number="26"><span class="st">    kappa ~ gamma(0.1,0.1);</span></a>
<a class="sourceLine" id="cb32-27" data-line-number="27"><span class="st">} &quot;</span></a></code></pre></div>
</section><section class="slide level2">

<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">pos_fit &lt;-<span class="st"> </span><span class="kw">stan</span>(<span class="dt">model_code=</span>pos_model, <span class="dt">chains=</span><span class="dv">3</span>, <span class="dt">iter=</span><span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">                  <span class="dt">data=</span><span class="kw">list</span>(<span class="dt">N=</span><span class="kw">nrow</span>(batting),</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">                            <span class="dt">hits=</span>batting<span class="op">$</span>Hits,</a>
<a class="sourceLine" id="cb33-4" data-line-number="4">                            <span class="dt">at_bats=</span>batting<span class="op">$</span>AtBats,</a>
<a class="sourceLine" id="cb33-5" data-line-number="5">                            <span class="dt">npos=</span><span class="kw">nlevels</span>(batting<span class="op">$</span>PriPos),</a>
<a class="sourceLine" id="cb33-6" data-line-number="6">                            <span class="dt">position=</span><span class="kw">as.numeric</span>(batting<span class="op">$</span>PriPos)))</a></code></pre></div>
<pre><code>## 
## SAMPLING FOR MODEL &#39;2932a88214bc55d6ecc7d82d54192dca&#39; NOW (CHAIN 1).
## 
## Gradient evaluation took 0.000907 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 9.07 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:   1 / 1000 [  0%]  (Warmup)
## Iteration: 100 / 1000 [ 10%]  (Warmup)
## Iteration: 200 / 1000 [ 20%]  (Warmup)
## Iteration: 300 / 1000 [ 30%]  (Warmup)
## Iteration: 400 / 1000 [ 40%]  (Warmup)
## Iteration: 500 / 1000 [ 50%]  (Warmup)
## Iteration: 501 / 1000 [ 50%]  (Sampling)
## Iteration: 600 / 1000 [ 60%]  (Sampling)
## Iteration: 700 / 1000 [ 70%]  (Sampling)
## Iteration: 800 / 1000 [ 80%]  (Sampling)
## Iteration: 900 / 1000 [ 90%]  (Sampling)
## Iteration: 1000 / 1000 [100%]  (Sampling)
## 
##  Elapsed Time: 48.7161 seconds (Warm-up)
##                17.2383 seconds (Sampling)
##                65.9545 seconds (Total)
## 
## 
## SAMPLING FOR MODEL &#39;2932a88214bc55d6ecc7d82d54192dca&#39; NOW (CHAIN 2).
## 
## Gradient evaluation took 0.000914 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 9.14 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:   1 / 1000 [  0%]  (Warmup)
## Iteration: 100 / 1000 [ 10%]  (Warmup)
## Iteration: 200 / 1000 [ 20%]  (Warmup)
## Iteration: 300 / 1000 [ 30%]  (Warmup)
## Iteration: 400 / 1000 [ 40%]  (Warmup)
## Iteration: 500 / 1000 [ 50%]  (Warmup)
## Iteration: 501 / 1000 [ 50%]  (Sampling)
## Iteration: 600 / 1000 [ 60%]  (Sampling)
## Iteration: 700 / 1000 [ 70%]  (Sampling)
## Iteration: 800 / 1000 [ 80%]  (Sampling)
## Iteration: 900 / 1000 [ 90%]  (Sampling)
## Iteration: 1000 / 1000 [100%]  (Sampling)
## 
##  Elapsed Time: 54.066 seconds (Warm-up)
##                13.8432 seconds (Sampling)
##                67.9092 seconds (Total)
## 
## 
## SAMPLING FOR MODEL &#39;2932a88214bc55d6ecc7d82d54192dca&#39; NOW (CHAIN 3).
## 
## Gradient evaluation took 0.000591 seconds
## 1000 transitions using 10 leapfrog steps per transition would take 5.91 seconds.
## Adjust your expectations accordingly!
## 
## 
## Iteration:   1 / 1000 [  0%]  (Warmup)
## Iteration: 100 / 1000 [ 10%]  (Warmup)
## Iteration: 200 / 1000 [ 20%]  (Warmup)
## Iteration: 300 / 1000 [ 30%]  (Warmup)
## Iteration: 400 / 1000 [ 40%]  (Warmup)
## Iteration: 500 / 1000 [ 50%]  (Warmup)
## Iteration: 501 / 1000 [ 50%]  (Sampling)
## Iteration: 600 / 1000 [ 60%]  (Sampling)
## Iteration: 700 / 1000 [ 70%]  (Sampling)
## Iteration: 800 / 1000 [ 80%]  (Sampling)
## Iteration: 900 / 1000 [ 90%]  (Sampling)
## Iteration: 1000 / 1000 [100%]  (Sampling)
## 
##  Elapsed Time: 48.9429 seconds (Warm-up)
##                13.0577 seconds (Sampling)
##                62.0005 seconds (Total)</code></pre>
</section><section id="what-questions-can-we-ask" class="slide level2">
<h2>What questions can we ask?</h2>
<p>(discussion / see Kruschke Ch. 9)</p>
</section></section>
<section><section id="sharing-power-shrinkage" class="title-slide slide level1"><h1>Sharing power // Shrinkage</h1></section><section id="example" class="slide level2">
<h2>Example</h2>
<p>Suppose that I have a large pot of coins that are all similar to each other. I flip each one ten times, and record the number of Heads. What is <em>each coin’s</em> probability of Heads?</p>
<ul>
<li><p>Treated <em>separately</em>, we would be very uncertain about each coin.</p></li>
<li><p>Together, they should tell us very accurately what are <em>likely</em> values of <span class="math inline">\(\theta\)</span>.</p></li>
<li><p>This information can improve the estimate of each separate <span class="math inline">\(\theta\)</span>.</p></li>
</ul>
<div class="fragment">
<p>How does shrinkage affect the baseball inference?</p>
</div>
</section></section>
    </div>
  </div>

  <script src="reveal.js/lib/js/head.min.js"></script>
  <script src="reveal.js/js/reveal.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Display the page number of the current slide
        slideNumber: true,
        // Push each slide change to the browser history
        history: true,
        // Transition style
        transition: 'none', // none/fade/slide/convex/concave/zoom
        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // Optional reveal.js plugins
        dependencies: [
          { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
          { src: 'reveal.js/plugin/math/math.js', async: true },
          { src: 'reveal.js/plugin/notes/notes.js', async: true }
        ]
      });
    </script>
    </body>
</html>
